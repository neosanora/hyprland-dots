#!/usr/bin/env bash

ICON="$HOME/.config/hypr/scripts/assets/brightness.svg"

# Ambil brightness dari monitor (0–100)
get_hw_brightness_percent() {
    local out cur max
    out=$(ddcutil getvcp 10 2>/dev/null) || return 1
    cur=$(printf '%s' "$out" | sed -n 's/.*[Cc]urrent value *= *\([0-9][0-9]*\).*/\1/p' | head -n1)
    max=$(printf '%s' "$out" | sed -n 's/.*max value *= *\([0-9][0-9]*\).*/\1/p' | head -n1)

    if [ -z "$cur" ] || [ -z "$max" ] || [ "$max" -le 0 ]; then
        return 1
    fi

    # Pembulatan sederhana
    printf '%d\n' $(( (cur * 100 + max/2) / max ))
}


# Hitung step berdasarkan persentase (default 5%)
get_step() {
    local val=$1
    step=$((val / 20))   # 5% dari nilai sekarang
    [ "$step" -lt 1 ] && step=1
    echo "$step"
}

# Set brightness di monitor
apply_brightness() {
    local val=$1
    [ "$val" -lt 0 ] && val=0
    [ "$val" -gt 100 ] && val=100
    ddcutil setvcp 10 "$val" &>/dev/null &
}

# Notifikasi slider
notify_brightness() {
    local val=$1
    notify-send -h int:value:"$val" \
                -h string:x-canonical-private-synchronous:brightness \
                -u low "󰃠 Brightness" "$val%" \
                --icon="$ICON"
}

case "$1" in
    get)
        get_hw_brightness_percent
        ;;
    up)
        current=$(get_hw_brightness)
        step=$(get_step "$current")
        new=$((current + step))
        apply_brightness "$new"
        notify_brightness "$new"
        ;;
    down)
        current=$(get_hw_brightness)
        step=$(get_step "$current")
        new=$((current - step))
        apply_brightness "$new"
        notify_brightness "$new"
        ;;
    set)
        val="$2"
        apply_brightness "$val"
        notify_brightness "$val"
        ;;
    *)
        echo "Usage: $0 {get|up|down|set N}"
        ;;
esac
